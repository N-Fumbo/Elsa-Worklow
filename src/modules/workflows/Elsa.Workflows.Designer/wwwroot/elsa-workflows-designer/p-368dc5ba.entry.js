import{r as t,h as s,c as e}from"./p-a7a3baa1.js";import{I as i}from"./p-5b99439b.js";import{s as n}from"./p-1de51046.js";import{h as o}from"./p-4031f4ff.js";import{ag as a,C as l,x as r,B as c,o as d,f as w,r as h,g as u,h as f,a0 as p}from"./p-dd7ad463.js";import"./p-fcfa9e22.js";import{w as m,f as v}from"./p-e8341dd3.js";import"./p-144a434e.js";import"./p-72dc819a.js";import"./p-e71312f9.js";const x=class{constructor(e){t(this,e),this.findActivityDescriptor=()=>{const t=this.activity;if(!t)return null;const e=n.activityDescriptors.find((e=>e.typeName==t.type&&e.version==t.version));return null!=e?e:n.activityDescriptors.sort(((t,e)=>e.version-t.version)).find((t=>t.typeName==this.activity.type))},this.onSelectedTabIndexChanged=t=>this.selectedTabIndex=t.detail.selectedTabIndex,this.renderPropertiesTab=()=>{var t,e,n;const a=this.activity,o=this.findActivityDescriptor().inputs.filter((t=>t.isBrowsable)),l=a.id,r=null!==(e=null===(t=a.metadata)||void 0===t?void 0:t.displayText)&&void 0!==e?e:"",d=this.activityExecutionLog,c=null!==(n=null==d?void 0:d.activityState)&&void 0!==n?n:{},w={"Activity ID":l,"Display Text":r};for(const t of o){const e=c[t.name],s=null!==e&&"object"==typeof e?JSON.stringify(e):null!=e?e.toString():"";w[t.displayName]=s}return s("div",null,s(i,{title:"Properties",dictionary:w}))},this.renderCommonTab=()=>s("div",null),this.renderJournalTab=()=>{var t;const e=this.activityExecutionLog;if(null==e)return;const i=null===(t=e.payload)||void 0===t?void 0:t.exception,n="Completed"==e.eventName?"tw-bg-blue-100":"Faulted"==e.eventName?"tw-bg-red-100":"tw-bg-green-100",l=this.iconRegistry.getOrDefault(e.activityType)({size:a.Small});return s("div",{class:"tw-border-2 tw-cursor-pointer tw-p-4 tw-rounded"},s("div",{class:"tw-relative tw-pb-10"},s("div",{class:"tw-relative tw-flex tw-space-x-3"},s("div",null,s("span",{class:"tw-h-8 tw-w-8 tw-rounded tw-p-1 tw-bg-blue-500 tw-flex tw-items-center tw-justify-center tw-ring-8 tw-ring-white tw-mr-1"},l)),s("div",{class:"tw-min-w-0 tw-flex-1 tw-pt-1.5 tw-flex tw-justify-between tw-space-x-4"},s("div",null,s("h3",{class:"tw-text-lg tw-leading-6 tw-font-medium tw-text-gray-900"},e.activityType)),s("div",null,s("span",{class:`tw-relative tw-inline-flex tw-items-center tw-rounded-full ${n} tw-border tw-border-gray-300 tw-px-3 tw-py-0.5 tw-text-sm`},s("span",{class:"tw-absolute tw-flex-shrink-0 tw-flex tw-items-center tw-justify-center"},s("span",{class:"tw-h-1.5 tw-w-1.5 tw-rounded-full","aria-hidden":"true"})),s("span",{class:"tw-font-medium tw-text-gray-900"},e.eventName))),s("div",{class:"tw-text-right tw-text-sm tw-whitespace-nowrap tw-text-gray-500"},s("span",null,o(e.timestamp).format("DD-MM-YYYY HH:mm:ss"))))),s("div",{class:"tw-ml-12 tw-mt-2"},s("dl",{class:"sm:tw-divide-y sm:tw-divide-gray-200"},s("div",{class:"tw-grid tw-grid-cols-2 tw-gap-x-4 tw-gap-y-8 sm:tw-grid-cols-2"},s("div",{class:"sm:tw-col-span-2"},s("dt",{class:"tw-text-sm tw-font-medium tw-text-gray-500"},s("span",null,"Activity ID"),s("copy-button",{value:e.activityId})),s("dd",{class:"tw-mt-1 tw-text-sm tw-text-gray-900 tw-mb-2"},e.activityId)),i?[s("div",{class:"sm:tw-col-span-2"},s("dt",{class:"tw-text-sm tw-font-medium tw-text-gray-500"},s("span",null,"Exception"),s("copy-button",{value:i.Type+"\n"+i.Message})),s("dd",{class:"tw-mt-1 tw-text-sm tw-text-gray-900"},i.message)),s("div",{class:"sm:tw-col-span-2"},s("dt",{class:"tw-text-sm tw-font-medium tw-text-gray-500"},s("span",null,"Exception Details"),s("copy-button",{value:JSON.stringify(i,null,1)})),s("dd",{class:"tw-mt-1 tw-text-sm tw-text-gray-900 tw-overflow-x-auto"},s("pre",null,JSON.stringify(i,null,1))))]:void 0)))))},this.activity=void 0,this.activityExecutionLog=void 0,this.activityPropertyTabIndex=void 0,this.selectedTabIndex=0,this.iconRegistry=l.get(r)}async show(){await this.slideOverPanel.show()}async hide(){await this.slideOverPanel.hide()}async updateSelectedTab(t){this.selectedTabIndex=t}async componentWillLoad(){null!=this.activityPropertyTabIndex&&(this.selectedTabIndex=this.activityPropertyTabIndex)}render(){const t=this.activity,e=this.findActivityDescriptor(),i=e?[{displayText:"Properties",content:()=>this.renderPropertiesTab()},{displayText:"Common",content:()=>this.renderCommonTab()},{displayText:"Journal",content:()=>this.renderJournalTab()}]:[],n=t.id,a=e.displayName;return s("elsa-form-panel",{mainTitle:n,subTitle:a,tabs:i,selectedTabIndex:this.selectedTabIndex,onSelectedTabIndexChanged:t=>this.onSelectedTabIndexChanged(t)})}static get watchers(){return{activity:["componentWillLoad"]}}},y={Displaying:"workflow-instance-properties:displaying"},g=class{constructor(e){t(this,e),this.createModel=async()=>{const t={tabModels:[]},e=this.workflowDefinition,n=this.workflowInstance;if(!e||!n)return void(this.model=t);const a={name:"properties",tab:null,Widgets:[{name:"workflowInstanceInfo",content:()=>{const t={"Instance ID":d(n.id)?"(new)":n.id,"Definition ID":d(e.definitionId)?"(new)":e.definitionId,Version:e.version.toString()},a={Status:n.status,"Sub status":n.subStatus},o={Created:w(n.createdAt),"Last execution":w(n.updatedAt),Finished:w(n.finishedAt)};return s("div",null,s(i,{title:"Identity",dictionary:t}),s(i,{title:"Status",dictionary:a}),s(i,{title:"Timestamps",dictionary:o,hideEmptyValues:!0}))},order:10}]};a.tab={displayText:"Properties",content:()=>this.renderPropertiesTab(a)};const o={name:"variables",tab:{displayText:"Variables",content:()=>this.renderVariablesTab()}};t.tabModels=[a,o];const l={model:t};await this.eventBus.emit(y.Displaying,this,l),this.model=t},this.renderPropertiesTab=t=>{const e=t.Widgets.sort(((t,e)=>t.order<e.order?-1:t.order>e.order?1:0));return s("div",null,e.map((t=>t.content())))},this.renderVariablesTab=()=>{var t,e;const i=null!==(e=null===(t=this.workflowDefinition)||void 0===t?void 0:t.variables)&&void 0!==e?e:[];return s("div",null,s("elsa-variables-viewer",{variables:i,workflowDefinition:this.workflowDefinition,workflowInstance:this.workflowInstance}))},this.onSelectedTabIndexChanged=t=>this.selectedTabIndex=t.detail.selectedTabIndex,this.workflowDefinition=void 0,this.workflowInstance=void 0,this.model=void 0,this.selectedTabIndex=0,this.changeHandle={},this.eventBus=l.get(c),this.model={tabModels:[]}}async show(){await this.slideOverPanel.show()}async hide(){await this.slideOverPanel.hide()}async onWorkflowDefinitionChanged(){await this.createModel()}async onWorkflowInstanceChanged(){await this.createModel()}async componentWillLoad(){await this.createModel()}render(){const t=this.workflowDefinition,e=d(null==t?void 0:t.name)?"-":t.name,i=this.model.tabModels.map((t=>t.tab));return s("elsa-form-panel",{mainTitle:e,subTitle:"Workflow Instance",tabs:i,selectedTabIndex:this.selectedTabIndex,onSelectedTabIndexChanged:t=>this.onSelectedTabIndexChanged(t)})}static get watchers(){return{workflowDefinition:["onWorkflowDefinitionChanged"],workflowInstance:["onWorkflowInstanceChanged"]}}},b="table.workflow-journal-table tbody tr td{padding-top:0.5rem;padding-bottom:0.5rem;padding-left:0.75rem;padding-right:0px}table.workflow-journal-table tbody tr td:first-child{padding-top:0.5rem;padding-bottom:0.5rem;padding-left:0.75rem;padding-right:0px}",k=1e4,I=class{constructor(i){t(this,i),this.journalItemSelected=e(this,"journalItemSelected",7),this.renderBlocks=t=>{const e=this.journalActivityMap,i=this.iconRegistry,n=this.expandedBlocks;return this.sortByTimestamp(t).map((t=>{const o=e[t.nodeId].activity;if("Elsa.Workflow"==o.type||"Elsa.Flowchart"==o.type)return this.renderBlocks(t.children);const l=o.metadata,r=d(l.displayText)?o.id:l.displayText,c=h(t.duration),w=t.completed?"Completed":t.suspended?"Suspended":t.faulted?"Faulted":"Started",p=i.getOrDefault(o.type)({size:a.Small}),f=!!n.find((e=>e==t)),m=t.completed?"tw-bg-blue-100":t.faulted?"tw-bg-red-100":"tw-bg-green-100",v=f?s("svg",{class:"tw-h-6 tw-w-6 tw-text-gray-500",width:"24",height:"24",viewBox:"0 0 24 24","stroke-width":"2",stroke:"currentColor",fill:"none","stroke-linecap":"round","stroke-linejoin":"round"},s("path",{stroke:"none",d:"M0 0h24v24H0z"}),s("rect",{x:"4",y:"4",width:"16",height:"16",rx:"2"}),s("line",{x1:"9",y1:"12",x2:"15",y2:"12"})):s("svg",{class:"tw-h-6 tw-w-6 tw-text-gray-500",width:"24",height:"24",viewBox:"0 0 24 24","stroke-width":"2",stroke:"currentColor",fill:"none","stroke-linecap":"round","stroke-linejoin":"round"},s("path",{stroke:"none",d:"M0 0h24v24H0z"}),s("rect",{x:"4",y:"4",width:"16",height:"16",rx:"2"}),s("line",{x1:"9",y1:"12",x2:"15",y2:"12"}),s("line",{x1:"12",y1:"9",x2:"12",y2:"15"}));return[s("tr",null,s("td",{class:"tw-w-1"},t.children.length>0?s("a",{href:"#",onClick:e=>this.onBlockClick(e,t)},v):void 0),s("td",null,s("a",{href:"#",onClick:e=>this.onJournalItemClick(e,t,o)},u(t.timestamp))),s("td",{class:"tw-min-w-full"},s("div",{class:"tw-flex tw-items-center tw-space-x-1"},s("div",{class:"tw-flex-shrink"},s("div",{class:"tw-bg-blue-500 tw-rounded tw-p-1"},s("a",{href:"#",onClick:e=>this.onJournalItemClick(e,t,o)},p))),s("div",null,s("a",{href:"#",onClick:e=>this.onJournalItemClick(e,t,o)},r)))),s("td",null,s("a",{href:"#",onClick:e=>this.onJournalItemClick(e,t,o),class:`tw-inline-flex tw-rounded-full ${m} tw-px-2 tw-text-xs tw-font-semibold tw-leading-5 tw-text-green-800`},w)),s("td",null,s("a",{href:"#",onClick:e=>this.onJournalItemClick(e,t,o)},c))),f?this.renderBlocks(t.children):void 0]})).filter((t=>!!t))},this.loadJournalPage=async t=>{if(!this.model)return;const e=this.model.workflowInstance.id,s=await this.workflowInstancesApi.getJournal({page:t,pageSize:k,workflowInstanceId:e}),i=this.createBlocks(s.items),n=i.filter((t=>!t.parentActivityInstanceId));this.workflowExecutionLogRecords=[...this.workflowExecutionLogRecords,...s.items],this.rootBlocks=n,this.blocks=this.sortByTimestamp(i)},this.createBlocks=t=>{const e=t.filter((t=>"Started"==t.eventName)),s=t.filter((t=>"Completed"==t.eventName)),i=t.filter((t=>"Faulted"==t.eventName)),n=t.filter((t=>"Suspended"==t.eventName)),a=e.map((t=>{const e=s.find((e=>e.activityInstanceId==t.activityInstanceId)),a=i.find((e=>e.activityInstanceId==t.activityInstanceId)),o=n.find((e=>e.activityInstanceId==t.activityInstanceId)),l=e?f(e.timestamp,t.timestamp):null;return{nodeId:t.nodeId,activityId:t.activityId,activityInstanceId:t.activityInstanceId,parentActivityInstanceId:t.parentActivityInstanceId,completed:!!e,faulted:!!a,suspended:!!o,timestamp:t.timestamp,duration:l,startedRecord:t,completedRecord:e,faultedRecord:a,suspendedRecord:o,children:[]}}));for(const t of a)t.children=this.findChildBlocks(a,t.activityInstanceId);return a},this.findChildBlocks=(t,e)=>0==t.length?[]:e?t.filter((t=>t.parentActivityInstanceId==e)):t.filter((t=>!t.parentActivityInstanceId)),this.onBlockClick=(t,e)=>{t.preventDefault();const s=this.expandedBlocks.find((t=>t==e));this.expandedBlocks=s?this.expandedBlocks.filter((t=>t!=s)):[...this.expandedBlocks,e]},this.onJournalItemClick=async(t,e,s)=>{t.preventDefault(),this.journalItemSelected.emit({activity:s,executionEventBlock:e,activityNode:this.journalActivityMap[e.nodeId]})},this.model=void 0,this.workflowExecutionLogRecords=[],this.blocks=[],this.rootBlocks=[],this.expandedBlocks=[],this.journalActivityMap=new Set,this.iconRegistry=l.get(r),this.workflowInstancesApi=l.get(p)}async onWorkflowInstanceModelChanged(t,e){t.workflowInstance.id!=e.workflowInstance.id&&await this.refresh()}async componentWillLoad(){await this.refresh()}async refresh(){this.rootBlocks=[],await this.loadJournalPage(0),this.createActivityMapForJournal()}render(){return s("div",{class:"tw-absolute tw-inset-0 tw-overflow-hidden"},s("div",{class:"tw-h-full tw-flex tw-flex-col tw-bg-white tw-shadow-xl"},s("div",{class:"tw-flex tw-flex-col tw-flex-1"},s("div",{class:"tw-px-4 tw-py-6 tw-bg-gray-50 sm:tw-px-6"},s("div",{class:"tw-flex tw-items-start tw-justify-between tw-space-x-3"},s("div",{class:"tw-space-y-1"},s("h2",{class:"tw-text-lg tw-font-medium tw-text-gray-900"},"Workflow Journal")))),s("div",{class:"tw-flex-1 tw-relative"},s("div",{class:"tw-absolute tw-inset-0 tw-overflow-y-scroll"},s("table",{class:"workflow-journal-table"},s("thead",null,s("tr",null,s("th",{class:"tw-w-1"}),s("th",null,"Time"),s("th",{class:"tw-min-w-full"},"Activity"),s("th",null,"Status"),s("th",null,"Duration"))),s("tbody",{class:"tw-bg-white tw-divide-y tw-divide-gray-100"},this.renderBlocks(this.rootBlocks))))))))}sortByTimestamp(t){return t.sort((function(t,e){return t.timestamp>e.timestamp?1:-1}))}createActivityMapForJournal(){const t=this.model.workflowDefinition,e={type:"Elsa.Workflow",version:t.version,id:"Workflow1",root:t.root,variables:t.variables,metadata:{},customProperties:{}},s=m(e),i=v(s),n=new Set;for(const t of i)n[t.nodeId]=t;this.journalActivityMap=n,this.blocks=this.blocks.filter((t=>!!n[t.nodeId]))}static get watchers(){return{model:["onWorkflowInstanceModelChanged"]}}};I.style=b;export{x as elsa_activity_properties,g as elsa_workflow_instance_properties,I as elsa_workflow_journal};